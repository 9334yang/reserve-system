<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF 生物辨識打卡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial; padding: 16px; }
    .card { border:1px solid #eee; border-radius:12px; padding:16px; margin:12px 0; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    button { padding:12px 16px; border-radius:10px; border:1px solid #ddd; background:#fafafa; cursor:pointer; }
    .ok { color: #0a7a0a; }
    .err { color: #b00020; }
    .muted { color: #777; font-size: 12px; }
  </style>
</head>
<body>
  <h2>生物辨識打卡</h2>
  <div id="status" class="card">初始化中…</div>
  <div id="actions" class="card" style="display:none">
    <div id="user"></div>
    <div id="flow"></div>
    <div style="margin-top:12px">
      <button id="btn">開始</button>
    </div>
    <div id="hint" class="muted" style="margin-top:8px"></div>
  </div>
  <div id="log" class="card"></div>

  <script>
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwfLMa_8aUatD2MYVWciwy_UYjpFjRW57roYUcvxSkvvk1XPZiSS0UKdKZwlVKUfnVneg/exec'; // 由 doGet 注入（如果你前端不走 GAS 託管，就直接填部署網址）
    const LIFF_ID = '2007686418';

    const $ = (id)=> document.getElementById(id);
    const log = (...a)=> { const el=$('log'); el.innerHTML += `<div>${a.map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ')}</div>`; };
    const setStatus = (html)=> $('status').innerHTML = html;

    let profile = null;
    let staffExists = false;
    let savedCredentialId = null;

    // Base64URL 工具
    const b64uToBuf = (b64u) => {
      const pad = '='.repeat((4 - b64u.length % 4) % 4);
      const b64 = (b64u.replace(/-/g, '+').replace(/_/g, '/')) + pad;
      const str = atob(b64);
      const buf = new ArrayBuffer(str.length);
      const view = new Uint8Array(buf);
      for (let i=0;i<str.length;i++) view[i] = str.charCodeAt(i);
      return buf;
    };
    const bufToB64u = (buf) => {
      const bytes = (buf instanceof ArrayBuffer) ? new Uint8Array(buf) : new Uint8Array(buf.buffer);
      let str = '';
      for (let i=0;i<bytes.byteLength;i++) str += String.fromCharCode(bytes[i]);
      return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    };

    async function api(action, body) {
      const res = await fetch(GAS_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ action, ...body })
      });
      return res.json();
    }

    async function init() {
      try {
        setStatus('初始化 LIFF…');
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) liff.login();

        // 取得使用者資料
        const p = await liff.getProfile();
        profile = { userId: p.userId, displayName: p.displayName };
        $('user').innerHTML = `<b>${profile.displayName}</b> <span class="muted">(${profile.userId})</span>`;
        $('actions').style.display = '';

        // 檢查是否已註冊
        setStatus('檢查註冊狀態…');
        const ck = await api('checkStaff', { userId: profile.userId });
        staffExists = ck.exists;
        savedCredentialId = ck.staff?.credentialId || null;

        if (!staffExists || !savedCredentialId) {
          $('flow').innerHTML = '尚未註冊，將進行一次性的「裝置生物辨識註冊」。';
          $('btn').innerText = '開始註冊';
          $('btn').onclick = registerFlow;
          $('hint').innerText = '註冊後，未來靠近 NFC → 開啟頁面即可直接做生物辨識打卡。';
        } else {
          $('flow').innerHTML = '已註冊；將使用裝置生物辨識驗證後打卡。';
          $('btn').innerText = '開始驗證打卡';
          $('btn').onclick = authAndPunchFlow;
          $('hint').innerText = '若更換新手機，需重新註冊一次。';
        }
        setStatus('<span class="ok">準備就緒</span>');
      } catch (e) {
        setStatus(`<span class="err">初始化失敗</span>`);
        log('init error:', e);
      }
    }

    /** 註冊流程：navigator.credentials.create → 存 credentialId 到後端 */
    async function registerFlow() {
      try {
        $('btn').disabled = true;
        $('flow').innerHTML = '請使用 FaceID / 指紋 進行註冊…';

        // 最基本的 PublicKeyCredential 註冊參數（本機 Passkey）
        const pubKeyOpts = {
          publicKey: {
            rp: { name: "Punch System" },
            user: {
              id: new TextEncoder().encode(profile.userId),
              name: profile.userId,
              displayName: profile.displayName || profile.userId
            },
            challenge: crypto.getRandomValues(new Uint8Array(32)),
            pubKeyCredParams: [{ type: 'public-key', alg: -7 }], // ES256
            authenticatorSelection: { authenticatorAttachment: "platform", userVerification: "required" },
            timeout: 60000,
          }
        };
        const cred = await navigator.credentials.create(pubKeyOpts);
        if (!cred) throw new Error('註冊取消');

        const credentialId = bufToB64u(cred.rawId);
        // 儲存 credentialId 到後端
        const saved = await api('saveRegistration', {
          userId: profile.userId,
          displayName: profile.displayName,
          credentialId
        });

        if (!saved.ok) throw new Error(saved.error || 'saveRegistration 失敗');
        savedCredentialId = credentialId;
        staffExists = true;

        $('flow').innerHTML = '<span class="ok">註冊成功！</span> 現在進行首次驗證打卡…';
        await authAndPunchFlow();
      } catch (e) {
        $('flow').innerHTML = `<span class="err">註冊失敗：</span> ${e.message || e}`;
        log('register error:', e);
      } finally {
        $('btn').disabled = false;
      }
    }

    /** 驗證 + 打卡：navigator.credentials.get → 後端 punch */
    async function authAndPunchFlow() {
      try {
        $('btn').disabled = true;
        $('flow').innerHTML = '請使用 FaceID / 指紋 進行驗證…';

        // 若記錄了 credentialId，讓瀏覽器優先挑那把憑證
        const allow = savedCredentialId ? [{ type:'public-key', id: b64uToBuf(savedCredentialId) }] : [];
        const getOpts = {
          publicKey: {
            challenge: crypto.getRandomValues(new Uint8Array(32)),
            allowCredentials: allow,
            userVerification: 'required',
            timeout: 60000
          },
          mediation: 'required' // 嘗試直接喚起平台驗證
        };

        const assertion = await navigator.credentials.get(getOpts);
        if (!assertion) throw new Error('驗證取消');

        const usedCredId = bufToB64u(assertion.rawId);

        // 輕量驗證（server 僅比對 credentialId 是否一致）
        const punched = await api('punch', {
          userId: profile.userId,
          displayName: profile.displayName,
          credentialId: usedCredId
        });

        if (!punched.ok) {
          const msg = punched.reason || punched.error || '打卡失敗';
          $('flow').innerHTML = `<span class="err">${msg}</span>`;
          return;
        }
        $('flow').innerHTML = `<span class="ok">打卡成功</span>（${punched.type}）於 ${punched.time}，當日第 ${punched.count} 次。`;
      } catch (e) {
        $('flow').innerHTML = `<span class="err">驗證或打卡失敗：</span> ${e.message || e}`;
        log('auth error:', e);
      } finally {
        $('btn').disabled = false;
      }
    }

    // 自動啟動
    init();
  </script>
</body>
</html>
