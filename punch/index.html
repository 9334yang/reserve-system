<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF 生物辨識打卡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial; padding: 16px; }
    .card { border:1px solid #eee; border-radius:12px; padding:16px; margin:12px 0; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    button { padding:12px 16px; border-radius:10px; border:1px solid #ddd; background:#fafafa; cursor:pointer; }
    .ok { color:#0a7a0a; }
    .err { color:#b00020; }
    .muted { color:#777; font-size:12px; }
    #actions { display:none; }
    #openInLineBtn { display:none; margin-top:8px; }
  </style>
</head>
<body>
  <h2>生物辨識打卡</h2>

  <div id="status" class="card">初始化中…</div>

  <div class="card">
    <div class="muted">若非在 LINE App 內開啟，可能無法完整使用。</div>
    <button id="openInLineBtn">用 LINE 開啟</button>
  </div>

  <div id="actions" class="card">
    <div id="user"></div>
    <div id="flow" style="margin-top:8px"></div>
    <div style="margin-top:12px"><button id="btn">開始</button></div>
    <div id="hint" class="muted" style="margin-top:8px"></div>
  </div>

<script>
/* ===== 你的環境參數 ===== */
// 讀取用（GET）。若有 googleusercontent 的 echo 端點，建議貼到這裡會更穩
const GAS_GET_ENDPOINT  = 'https://script.google.com/macros/s/AKfycbxvmm0Qpko3wwM7gjuP7H-5rSbeYwAZNjGWXseiVdQk3xaopKhoL7wwi78AA7TMV0xq-w/exec';
// 寫入用（POST）
const GAS_POST_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxvmm0Qpko3wwM7gjuP7H-5rSbeYwAZNjGWXseiVdQk3xaopKhoL7wwi78AA7TMV0xq-w/exec';

const LIFF_ID = '2007686418-OvlBgmQW';

/* ===== DOM ===== */
const $ = id => document.getElementById(id);
const setStatus = html => $('status').innerHTML = html;

let profile = null;
let staffExists = false;
let savedCredentialId = null;

/* ===== Base64URL 工具 ===== */
const b64uToBuf = (b64u) => {
  const pad = '='.repeat((4 - b64u.length % 4) % 4);
  const b64 = (b64u.replace(/-/g,'+').replace(/_/g,'/')) + pad;
  const str = atob(b64);
  const buf = new ArrayBuffer(str.length);
  const view = new Uint8Array(buf);
  for (let i=0;i<str.length;i++) view[i] = str.charCodeAt(i);
  return buf;
};
const bufToB64u = (buf) => {
  const bytes = (buf instanceof ArrayBuffer) ? new Uint8Array(buf) : new Uint8Array(buf.buffer);
  let str = ''; for (let i=0;i<bytes.byteLength;i++) str += String.fromCharCode(bytes[i]);
  return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
};

/* ===== API：讀取走 GET，寫入走 POST ===== */
async function apiGet(params) {
  const url = new URL(GAS_GET_ENDPOINT);
  Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k, String(v ?? '')));
  const res = await fetch(url.toString(), { method: 'GET' });
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { ok:false, error:'INVALID_JSON', raw:text, status:res.status }; }
}
async function apiPost(action, body) {
  const res = await fetch(GAS_POST_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ action, ...body })
  });
  const text = await res.text();
  try { return JSON.parse(text); } catch { return { ok:false, error:'INVALID_JSON', raw:text, status:res.status }; }
}
async function api(action, body = {}) {
  if (action === 'saveRegistration' || action === 'punch') {
    return apiPost(action, body);       // 寫入
  }
  return apiGet({ action, ...body });   // 讀取
}

/* ===== 初始化 ===== */
(async function init() {
  try {
    setStatus('初始化 LIFF…');

    // 被嵌入時嘗試頂層導轉
    if (window.top !== window.self) {
      try { window.top.location = window.location.href; } catch (_e) {}
    }

    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });

    if (!liff.isLoggedIn()) {
      // 使用 LIFF 深連結，避免尾斜線/301 問題
      liff.login({ redirectUri: `https://liff.line.me/${LIFF_ID}` });
      return;
    }

    if (!liff.isInClient()) {
      $('openInLineBtn').style.display = 'inline-block';
      $('openInLineBtn').onclick = () => location.href = `https://liff.line.me/${LIFF_ID}`;
    }

    // 取得使用者資料（getProfile，失敗則以 ID Token 備援）
    let p = null;
    try { p = await liff.getProfile(); } catch (_e) {}
    if (p && p.userId) profile = { userId: p.userId, displayName: p.displayName || '' };
    else {
      const idt = liff.getDecodedIDToken?.();
      if (idt?.sub) profile = { userId: idt.sub, displayName: '' };
      else throw new Error('無法取得使用者資料');
    }

    $('user').innerHTML = `<b>${profile.displayName || '（無暱稱）'}</b> <span class="muted">(${profile.userId})</span>`;
    $('actions').style.display = '';

    setStatus('檢查註冊狀態…');
    const ck = await api('checkStaff', { userId: profile.userId });
    staffExists = !!ck.exists;
    savedCredentialId = ck.staff?.credentialId || null;

    if (!staffExists || !savedCredentialId) {
      $('flow').textContent = '尚未註冊，將進行一次性的「裝置生物辨識註冊」。';
      $('btn').textContent = '開始註冊';
      $('btn').onclick = registerFlow;
      $('hint').textContent = '註冊後，靠近 NFC 開啟即可直接驗證打卡。';
    } else {
      $('flow').textContent = '已註冊；將使用裝置生物辨識驗證後打卡。';
      $('btn').textContent = '開始驗證打卡';
      $('btn').onclick = authAndPunchFlow;
      $('hint').textContent = '若更換新手機，需重新註冊一次。';
    }

    setStatus('<span class="ok">準備就緒</span>');
  } catch (e) {
    setStatus('<span class="err">初始化失敗</span>');
  }
})();

/* ===== 註冊（WebAuthn create） ===== */
async function registerFlow() {
  try {
    $('btn').disabled = true;
    $('flow').textContent = '請使用 FaceID / 指紋 進行註冊…';
    if (!window.PublicKeyCredential) throw new Error('此裝置/瀏覽器不支援 WebAuthn');

    const cred = await navigator.credentials.create({
      publicKey: {
        rp: { name: 'Punch System' },
        user: { id: new TextEncoder().encode(profile.userId), name: profile.userId, displayName: profile.displayName || profile.userId },
        challenge: crypto.getRandomValues(new Uint8Array(32)),
        pubKeyCredParams: [{ type:'public-key', alg:-7 }], // ES256
        authenticatorSelection: { authenticatorAttachment:'platform', userVerification:'required' },
        timeout: 60000
      }
    });
    if (!cred) throw new Error('註冊取消');

    const credentialId = bufToB64u(cred.rawId);
    const saved = await api('saveRegistration', {
      userId: profile.userId,
      displayName: profile.displayName,
      credentialId
    });
    if (!saved.ok) throw new Error(saved.error || 'saveRegistration 失敗');

    savedCredentialId = credentialId;
    $('flow').innerHTML = '<span class="ok">註冊成功！</span> 現在進行首次驗證打卡…';
    await authAndPunchFlow();
  } catch (e) {
    $('flow').innerHTML = `<span class="err">註冊失敗：</span> ${e.message || e}`;
  } finally {
    $('btn').disabled = false;
  }
}

/* ===== 驗證 + 打卡（WebAuthn get → punch） ===== */
async function authAndPunchFlow() {
  try {
    $('btn').disabled = true;
    $('flow').textContent = '請使用 FaceID / 指紋 進行驗證…';
    if (!window.PublicKeyCredential) throw new Error('此裝置/瀏覽器不支援 WebAuthn');

    const allow = savedCredentialId ? [{ type:'public-key', id:b64uToBuf(savedCredentialId) }] : [];
    const assertion = await navigator.credentials.get({
      publicKey: { challenge: crypto.getRandomValues(new Uint8Array(32)), allowCredentials: allow, userVerification: 'required', timeout: 60000 },
      mediation: 'required'
    });
    if (!assertion) throw new Error('驗證取消');

    const usedCredId = bufToB64u(assertion.rawId);
    const punched = await api('punch', {
      userId: profile.userId,
      displayName: profile.displayName,
      credentialId: usedCredId
    });

    if (!punched.ok) {
      $('flow').innerHTML = `<span class="err">${punched.reason || punched.error || '打卡失敗'}</span>`;
      return;
    }

    $('flow').innerHTML = `<span class="ok">打卡成功</span>（${punched.type}）於 ${punched.time}，當日第 ${punched.count} 次。`;
  } catch (e) {
    $('flow').innerHTML = `<span class="err">驗證或打卡失敗：</span> ${e.message || e}`;
  } finally {
    $('btn').disabled = false;
  }
}
</script>
</body>
</html>
