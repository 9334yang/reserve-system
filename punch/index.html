<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF 生物辨識打卡（合規防阻擋版）</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial; padding: 16px; }
    .card { border:1px solid #eee; border-radius:12px; padding:16px; margin:12px 0; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    button { padding:12px 16px; border-radius:10px; border:1px solid #ddd; background:#fafafa; cursor:pointer; }
    .ok { color: #0a7a0a; }
    .err { color: #b00020; }
    .muted { color: #777; font-size: 12px; }
    #openInLineBtn { display:none; margin-top:10px; }
    #actions { display:none; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <h2>生物辨識打卡</h2>

  <div id="status" class="card">初始化中…</div>

  <div class="card">
    <div class="muted">
      若您不是在 LINE App 內開啟，可能無法完整使用。請點下方按鈕以 LINE 開啟。
    </div>
    <button id="openInLineBtn">用 LINE 開啟</button>
  </div>

  <div id="actions" class="card">
    <div id="user"></div>
    <div id="flow" style="margin-top:8px"></div>
    <div style="margin-top:12px">
      <button id="btn">開始</button>
    </div>
    <div id="hint" class="muted" style="margin-top:8px"></div>
  </div>

  <div id="log" class="card"><b>診斷輸出：</b><pre id="logpre"></pre></div>

  <script>
    /** === 你的環境參數（可改） === */
    const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwfLMa_8aUatD2MYVWciwy_UYjpFjRW57roYUcvxSkvvk1XPZiSS0UKdKZwlVKUfnVneg/exec';
    const LIFF_ID      = '2007686418-OvlBgmQW';

    /** === DOM 工具 === */
    const $ = (id)=> document.getElementById(id);
    const setStatus = (html)=> $('status').innerHTML = html;
    const log = (...a)=> {
      const s = a.map(x => typeof x === 'string' ? x : JSON.stringify(x, null, 2)).join(' ');
      $('logpre').textContent += s + '\n';
    };

    let profile = null;
    let staffExists = false;
    let savedCredentialId = null;

    /** === Base64URL / ArrayBuffer 轉換 === */
    const b64uToBuf = (b64u) => {
      const pad = '='.repeat((4 - b64u.length % 4) % 4);
      const b64 = (b64u.replace(/-/g, '+').replace(/_/g, '/')) + pad;
      const str = atob(b64);
      const buf = new ArrayBuffer(str.length);
      const view = new Uint8Array(buf);
      for (let i=0;i<str.length;i++) view[i] = str.charCodeAt(i);
      return buf;
    };
    const bufToB64u = (buf) => {
      const bytes = (buf instanceof ArrayBuffer) ? new Uint8Array(buf) : new Uint8Array(buf.buffer);
      let str = '';
      for (let i=0;i<bytes.byteLength;i++) str += String.fromCharCode(bytes[i]);
      return btoa(str).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    };

    /** === 後端 API === */
    async function api(action, body) {
      const res = await fetch(GAS_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ action, ...body })
      });
      const data = await res.json();
      return data;
    }

    /** === 合規防阻擋：初始化流程 === */
    async function init() {
      try {
        setStatus('初始化 LIFF…');
        log('env', { href: location.href, ua: navigator.userAgent });

        // 1) 若被嵌入（可能遇到 X-Frame-Options / CSP），嘗試頂層導轉
        if (window.top !== window.self) {
          log('detected in iframe → try top redirect');
          try {
            window.top.location = window.location.href;
            // 注意：此行之後瀏覽器通常會離開，不再執行後續
          } catch (e) {
            log('top redirect failed (sandboxed frame?)', e);
          }
        }

        // 2) LIFF 初始化（支援外部瀏覽器自動登入）
        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });
        log('liff.init ok', { inClient: liff.isInClient(), os: liff.getOS(), lang: liff.getLanguage() });

        // 3) 若未登入，觸發頂層導轉登入，並 **return** 避免往下執行導致誤判失敗
        if (!liff.isLoggedIn()) {
          log('not logged in → liff.login and return');
          liff.login({ redirectUri: location.href });
          return;
        }

        // 4) 若不在 LINE 內，顯示「用 LINE 開啟」按鈕（深連結）
        if (!liff.isInClient()) {
          $('openInLineBtn').style.display = 'inline-block';
          $('openInLineBtn').onclick = () => {
            location.href = `https://liff.line.me/${LIFF_ID}`;
          };
        }

        // 5) 取得使用者資料（getProfile → 失敗再 fallback 到 ID Token）
        let p = null;
        try {
          p = await liff.getProfile();
        } catch (e) {
          log('getProfile failed, try getDecodedIDToken', e);
        }

        if (p && p.userId) {
          profile = { userId: p.userId, displayName: p.displayName || '' };
        } else {
          const idt = liff.getDecodedIDToken?.();
          if (idt?.sub) {
            profile = { userId: idt.sub, displayName: '' };
          } else {
            throw new Error('無法取得使用者資料（getProfile 與 ID Token 皆失敗）');
          }
        }

        $('user').innerHTML = `<b>${profile.displayName || '（無暱稱）'}</b> <span class="muted">(${profile.userId})</span>`;
        $('actions').style.display = '';

        setStatus('檢查註冊狀態…');
        const ck = await api('checkStaff', { userId: profile.userId });
        log('checkStaff', ck);

        staffExists = !!ck.exists;
        savedCredentialId = ck.staff?.credentialId || null;

        if (!staffExists || !savedCredentialId) {
          $('flow').innerHTML = '尚未註冊，將進行一次性的「裝置生物辨識註冊」。';
          $('btn').innerText = '開始註冊';
          $('btn').onclick = registerFlow;
          $('hint').innerText = '註冊後，未來靠近 NFC → 開啟頁面即可直接做生物辨識打卡。';
        } else {
          $('flow').innerHTML = '已註冊；將使用裝置生物辨識驗證後打卡。';
          $('btn').innerText = '開始驗證打卡';
          $('btn').onclick = authAndPunchFlow;
          $('hint').innerText = '若更換新手機，需重新註冊一次。';
        }

        setStatus('<span class="ok">準備就緒</span>');
      } catch (e) {
        setStatus('<span class="err">初始化失敗</span>');
        log('init error', { message: e?.message, name: e?.name, stack: e?.stack });
        log('hints', [
          '1) 確認 LIFF_ID 正確，且與設定一致',
          '2) LIFF → Endpoint URL 與實際開啟的網域一致（GAS 多為 script.google.com / googleusercontent.com）',
          '3) LIFF Scope 勾選 profile',
          '4) 優先在 LINE App 內開啟或使用上方「用 LINE 開啟」'
        ]);
      }
    }

    /** === 註冊流程（WebAuthn create） === */
    async function registerFlow() {
      try {
        $('btn').disabled = true;
        $('flow').innerHTML = '請使用 FaceID / 指紋 進行註冊…';

        // 環境檢查：WebAuthn 是否可用
        if (!window.PublicKeyCredential) {
          throw new Error('此裝置/瀏覽器不支援 WebAuthn');
        }

        const pubKeyOpts = {
          publicKey: {
            rp: { name: "Punch System" },
            user: {
              id: new TextEncoder().encode(profile.userId),
              name: profile.userId,
              displayName: profile.displayName || profile.userId
            },
            challenge: crypto.getRandomValues(new Uint8Array(32)),
            pubKeyCredParams: [{ type: 'public-key', alg: -7 }], // ES256
            authenticatorSelection: { authenticatorAttachment: "platform", userVerification: "required" },
            timeout: 60000
          }
        };

        const cred = await navigator.credentials.create(pubKeyOpts);
        if (!cred) throw new Error('註冊取消');

        const credentialId = bufToB64u(cred.rawId);
        const saved = await api('saveRegistration', {
          userId: profile.userId,
          displayName: profile.displayName,
          credentialId
        });
        if (!saved.ok) throw new Error(saved.error || 'saveRegistration 失敗');

        savedCredentialId = credentialId;
        staffExists = true;

        $('flow').innerHTML = '<span class="ok">註冊成功！</span> 現在進行首次驗證打卡…';
        await authAndPunchFlow();
      } catch (e) {
        $('flow').innerHTML = `<span class="err">註冊失敗：</span> ${e.message || e}`;
        log('register error', e);
      } finally {
        $('btn').disabled = false;
      }
    }

    /** === 驗證 + 打卡（WebAuthn get → punch） === */
    async function authAndPunchFlow() {
      try {
        $('btn').disabled = true;
        $('flow').innerHTML = '請使用 FaceID / 指紋 進行驗證…';

        if (!window.PublicKeyCredential) {
          throw new Error('此裝置/瀏覽器不支援 WebAuthn');
        }

        const allow = savedCredentialId ? [{ type:'public-key', id: b64uToBuf(savedCredentialId) }] : [];
        const getOpts = {
          publicKey: {
            challenge: crypto.getRandomValues(new Uint8Array(32)),
            allowCredentials: allow,
            userVerification: 'required',
            timeout: 60000
          },
          mediation: 'required' // 嘗試直接喚起平台驗證
        };

        const assertion = await navigator.credentials.get(getOpts);
        if (!assertion) throw new Error('驗證取消');
        const usedCredId = bufToB64u(assertion.rawId);

        // 輕量驗證：只比對 credentialId；若要強驗簽，需在後端驗證 signature。
        const punched = await api('punch', {
          userId: profile.userId,
          displayName: profile.displayName,
          credentialId: usedCredId
        });

        if (!punched.ok) {
          const msg = punched.reason || punched.error || '打卡失敗';
          $('flow').innerHTML = `<span class="err">${msg}</span>`;
          return;
        }
        $('flow').innerHTML = `<span class="ok">打卡成功</span>（${punched.type}）於 ${punched.time}，當日第 ${punched.count} 次。`;
      } catch (e) {
        $('flow').innerHTML = `<span class="err">驗證或打卡失敗：</span> ${e.message || e}`;
        log('auth error', e);
      } finally {
        $('btn').disabled = false;
      }
    }

    // 自動啟動
    init();
  </script>
</body>
</html>
