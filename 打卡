<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LINE 一鍵打卡</title>
  <style>
    :root{ color-scheme: light dark; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial;
          background:#0f172a; color:#e2e8f0; min-height:100vh; display:grid; place-items:center; }
    .card{ width:min(640px,92%); background:#111827; border:1px solid #1f2937; border-radius:16px; padding:22px; text-align:center; }
    h1{ margin:0 0 8px 0; font-size:26px; }
    .name{ font-size:20px; opacity:.9; margin-bottom:14px; }
    button{ padding:12px 18px; border:0; border-radius:12px; background:#0ea5e9; color:#fff; font-weight:700; cursor:pointer; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .msg{ margin-top:12px; white-space:pre-wrap; font-size:14px; opacity:.9; }
    .muted{ opacity:.7; font-size:12px; margin-top:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>一鍵打卡</h1>
    <div class="name" id="name">讀取中…</div>
    <button id="btn" disabled>打卡</button>
    <div class="msg" id="msg">初始化 LIFF 中…</div>
    <div class="muted">若卡住可關閉重開或稍後重試</div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // 你的參數（可改）
    const LIFF_ID = '2007686418-OvlBgmQW';
    const GAS_URL = 'TiJxcfLe6axUxBZa/GEIBTHskEICFdvZCjzombACSO4rxp8/xBQqrmjWNJZDYgdtZp9xXIi8GbhuCdxRIjxT+e7KamCswg5LPK1SAEyktZyY4TxP181L9P76c5KpvtYSr/FAwsGRaVPXgIMZjcNlogdB04t89/1O/w1cDnyilFU=';

    const $ = (id) => document.getElementById(id);
    const show = (t) => { $('msg').textContent = t; };
    let identity = { userId: '', displayName: '' };

    async function initLiff() {
      show('初始化 LIFF…');
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login({}); return false; }

      show('讀取使用者資料…');
      const idt = liff.getDecodedIDToken();     // 需 openid
      const prof = await liff.getProfile();     // 需 profile
      if (!idt || !idt.sub) throw new Error('未取得 userId（請確認 LIFF scope 勾選 openid）');

      identity.userId = idt.sub;
      identity.displayName = prof.displayName || '';
      $('name').textContent = identity.displayName ? `嗨，${identity.displayName}` : '歡迎使用';
      $('btn').disabled = false;
      show('就緒，請按下「打卡」。');
      return true;
    }

    async function punch() {
      $('btn').disabled = true;
      show('送出打卡中…');

      try {
        // 用 text/plain → simple request，避免 CORS/預檢
        const res = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({
            action: 'punch',
            userId: identity.userId,
            displayName: identity.displayName,
            ts: Date.now()
          })
        });

        const txt = await res.text();
        let j; try { j = JSON.parse(txt); } catch { j = { success:false, message:'GAS 回傳非 JSON', raw: txt }; }

        if (j.success) {
          show('✅ ' + (j.message || '打卡成功'));
        } else {
          show('❌ ' + (j.message || '打卡失敗'));
        }
      } catch (e) {
        show('❌ ' + (e.message || e));
      } finally {
        $('btn').disabled = false;
      }
    }

    $('btn').addEventListener('click', punch);
    // 進頁面就先初始化
    initLiff().catch(err => show('❌ ' + err.message));
  </script>
</body>
</html>
