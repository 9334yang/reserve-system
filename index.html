<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>預約系統（含除錯面板）</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial;background:#f7f7f7;margin:0}
    header{padding:10px 14px;background:#111;color:#fff;display:flex;align-items:center;justify-content:space-between}
    header small{opacity:.8}
    main{padding:16px;max-width:920px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:#fff;border:1px solid #eee;border-radius:12px;padding:12px}
    pre{margin:0;background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px;white-space:pre-wrap;word-break:break-word;max-height:260px;overflow:auto}
    .row{margin:10px 0}
    .btn{padding:8px 12px;border:1px solid #ddd;border-radius:10px;background:#fff;margin-right:8px;cursor:pointer}
    .ok{color:#137333;font-weight:600}
    .bad{color:#b00020;font-weight:600}
    .warn{color:#b35a00;font-weight:600}
    .pill{display:inline-block;background:#eee;border-radius:999px;padding:2px 8px;margin-right:6px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <div><b>預約系統</b> <small id="build">BUILD: 2025-09-11T00:00:00</small></div>
    <div>
      <button id="btnOpenLiffUrl" class="btn">用 LIFF URL</button>
      <button id="btnLogin" class="btn">登入</button>
      <button id="btnLogout" class="btn">登出</button>
      <button id="btnReload" class="btn">重整</button>
    </div>
  </header>

  <main class="grid">
    <section class="card">
      <h3>除錯狀態</h3>
      <div class="row">
        <span class="pill" id="pInClient">inClient: ?</span>
        <span class="pill" id="pLoggedIn">loggedIn: ?</span>
        <span class="pill" id="pScopes">scopes: ?</span>
        <span class="pill" id="pGAS">GAS: 未檢查</span>
      </div>
      <div class="row"><b>訊息</b>
        <pre id="judge">初始化中…</pre>
      </div>
      <div class="row"><b>步驟日誌</b>
        <pre id="log">開始載入頁面…</pre>
      </div>
    </section>

    <aside class="card">
      <h3>環境資訊</h3>
      <div class="row"><b>目前頁面來源 / 網域</b><pre id="origin">（尚未取得）</pre></div>
      <div class="row"><b>LIFF 環境</b><pre id="env">（尚未取得）</pre></div>
      <div class="row"><b>getProfile()</b><pre id="profile">（尚未取得）</pre></div>
      <div class="row"><b>getDecodedIDToken()</b><pre id="idtoken">（尚未取得）</pre></div>
      <div class="row"><b>寫入結果</b><pre id="write">（尚未傳送）</pre></div>
    </aside>
  </main>

<script>
/* ===== 你要更新的兩個常數 ===== */
const LIFF_ID = "2007686418-Gy0woWJ2"; // ← 改成你的 LIFF ID
const GAS_URL = "https://script.google.com/macros/s/AKfycbwXrSaExPwjh3U9-vQFB4FA-xhIDUwUTAzJD0drhbBhki7_Muc5KXnchJVNpYCV0qtEGw/exec"; // ← 改成目前部署成功的 exec

/* ===== 小工具 ===== */
const $ = (id)=>document.getElementById(id);
const log = (m)=>{ $('log').textContent += "\n" + m; };
const setPill = (el, txt, cls)=>{ el.textContent = txt; el.className = 'pill' + (cls?(' '+cls):''); }
const J = (x)=>JSON.stringify(x, null, 2);

/* ===== 全域錯誤攔截（能看到卡住的堆疊） ===== */
window.onerror = (msg, src, line, col, err)=>{
  log("❌ onerror: " + msg + " @ " + src + ":" + line + ":" + col + "\n" + (err?.stack||""));
  $('judge').textContent = "❌ 頁面 JS 錯誤（見步驟日誌）";
};
window.onunhandledrejection = (ev)=>{
  const e = ev?.reason || ev;
  log("❌ Unhandled Rejection: " + (e?.message || e));
};
(function ping(){ log("✅ HTML 已載入 @ " + new Date().toLocaleString()); })();

/* ===== 顯示來源（用來比對 Endpoint 網域） ===== */
$('origin').textContent = J({
  href: location.href, origin: location.origin, host: location.host,
  hostname: location.hostname, protocol: location.protocol
});

/* ===== 先測 GAS 是否可達（避免你卡在前端以為是 LIFF 問題） ===== */
(async function checkGAS(){
  try{
    const r = await fetch(GAS_URL + (GAS_URL.includes('?')?'&':'?') + 'ping=1', { method: 'GET', cache: 'no-store' });
    const t = await r.text().catch(()=> '');
    if (r.ok && (t.trim()==='OK' || t.trim()==='GAS OK')) {
      setPill($('pGAS'), 'GAS: OK', 'ok');
    } else {
      setPill($('pGAS'), 'GAS: NG('+r.status+')', 'bad');
      log('⚠️ GAS 回應：' + t);
    }
  } catch(e){
    setPill($('pGAS'), 'GAS: 連線失敗', 'bad');
    log('❌ GAS 連線錯誤：' + (e?.message||e));
  }
})();

/* ===== LIFF 初始化（含逾時計時器 + 具體判斷） ===== */
(async function run(){
  try{
    log("檢查 window.liff：typeof liff = " + (typeof liff));
    if (typeof liff === "undefined") {
      $('judge').textContent = "❌ LIFF SDK 沒載入（網路被擋或 <script src> 寫錯）";
      return;
    }

    log("呼叫 liff.init()，liffId=" + LIFF_ID);
    const initP = liff.init({ liffId: LIFF_ID });

    // 12 秒 watchdog：多半是 Endpoint/網域不匹配
    const timeout = new Promise((_,rej)=>setTimeout(()=>rej(new Error(
      "⏳ liff.init() 逾時：\n" +
      "• 你目前在「" + location.host + "」。\n" +
      "• 請確認 LINE Developers 的 Endpoint URL 指向這個網域（例：github.io/reserve-system）。\n" +
      "• 改完記得 Publish；LINE 內建瀏覽器快取重，連結加 ?v=時間戳 重開。"
    )), 12000));

    await Promise.race([initP, timeout]);
    await (liff.ready || Promise.resolve());

    const env = {
      inClient: liff.isInClient(),
      loggedIn: liff.isLoggedIn(),
      os: liff.getOS(),
      lang: liff.getLanguage(),
      version: liff.getVersion(),
      lineVersion: (liff.getLineVersion && liff.getLineVersion()) || null
    };
    $('env').textContent = J(env);
    setPill($('pInClient'), 'inClient: '+env.inClient, env.inClient?'ok':'bad');
    setPill($('pLoggedIn'), 'loggedIn: '+env.loggedIn, env.loggedIn?'ok':'bad');

    // 未登入就導去登入
    if (!env.loggedIn) {
      log("未登入 → 觸發 liff.login()");
      $('judge').textContent = "未登入，準備導向登入…";
      liff.login({ redirectUri: location.href });
      return;
    }

    // 取得 profile
    let prof = null, profErr = null;
    try {
      log("呼叫 liff.getProfile()…");
      prof = await liff.getProfile(); // 需要 scope: profile
      $('profile').textContent = J(prof);
    } catch (e) {
      profErr = String(e?.message || e);
      $('profile').textContent = "（失敗）\n" + profErr;
      log("getProfile() 失敗：" + profErr);
    }

    // 取得 decoded token（需要 openid）
    let dec = null;
    try { dec = liff.getDecodedIDToken?.(); } catch(_){}
    $('idtoken').textContent = dec ? J(dec) : "（沒有 decoded ID token，可能沒勾 openid）";

    // 判斷 scope 狀態
    const scopeMsgs = [];
    if (prof && prof.userId) scopeMsgs.push('profile: OK');
    else scopeMsgs.push('profile: NG');
    if (dec && dec.sub) scopeMsgs.push('openid: OK');
    else scopeMsgs.push('openid: NG');
    setPill($('pScopes'), 'scopes: ' + scopeMsgs.join(', '), (scopeMsgs.includes('NG')?'warn':'ok'));

    // 最終判斷 & 提示
    const msgs = [];
    if (!env.inClient) msgs.push("❌ 不在 LINE App 內（請從 LIFF 連結開啟）");
    if (prof && prof.userId) msgs.push("✅ getProfile() 取得 userId：" + prof.userId);
    if (dec && dec.sub) msgs.push("✅ decoded ID token（sub）也有 userId：" + dec.sub);
    if (!prof && !dec) msgs.push("❌ 兩者皆無 → 多半是 scope 未勾 profile/openid 或 Endpoint 未 Publish。");
    $('judge').textContent = msgs.join("\n") || "環境正常";

    // （可選）把 userId 寫進表
    const userId = (prof && prof.userId) || (dec && dec.sub) || '';
    if (!userId) return;
    try{
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ userId, ts: new Date().toISOString() }),
        cache: 'no-store'
      });
      const data = await res.json().catch(()=> ({}));
      if (res.ok && data.ok) { $('write').textContent = "✅ 已成功寫入試算表"; $('write').className="ok"; }
      else { $('write').textContent = "❌ 寫入失敗：" + (data.error || ('HTTP '+res.status)); $('write').className="bad"; }
    }catch(e){
      $('write').textContent = "❌ 寫入失敗（fetch 例外）：" + (e?.message || e); $('write').className="bad";
    }

  } catch (err) {
    log("初始化期間發生錯誤：" + (err?.stack || String(err)));
    $('judge').textContent = "❌ liff.init 失敗/逾時（見步驟日誌）。\n" +
      "最常見：Endpoint 與此頁網域不一致、或後台改完未 Publish、或使用舊卡片/快取。";
  }
})();

/* ===== 快捷按鈕 ===== */
$('btnOpenLiffUrl').onclick = ()=> location.href = "https://liff.line.me/" + LIFF_ID + "?v=" + Date.now();
$('btnLogin').onclick = ()=> liff.login({ redirectUri: location.href });
$('btnLogout').onclick = ()=> { liff.logout(); location.reload(); };
$('btnReload').onclick = ()=> location.reload();

/* ===== 顯示目前 build 時間，方便判斷是否載到最新版 ===== */
(function setBuild(){
  const now = new Date().toISOString();
  $('build').textContent = 'BUILD: ' + now;
})();
</script>
</body>
</html>
