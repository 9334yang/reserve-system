<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF 除錯工具 (ES5)</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",Arial;padding:16px}
    pre{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px;white-space:pre-wrap;word-break:break-word}
    .row{margin:12px 0}.ok{color:green;font-weight:600}.bad{color:#b00020;font-weight:600}
    .btn{padding:8px 12px;border:1px solid #ddd;border-radius:10px;background:#fff;margin-right:8px}
  </style>
</head>
<body>
  <h1>LIFF 除錯工具</h1>
  <h3 style="color:red">BUILD: GAS-ES5</h3>

  <div class="row">
    <button id="btnOpenLiffUrl" class="btn">用 LIFF URL 開啟</button>
    <button id="btnLogin" class="btn">強制登入</button>
    <button id="btnLogout" class="btn">登出</button>
    <button id="btnReload" class="btn">重新整理</button>
  </div>

  <div class="row"><b>步驟日誌</b><pre id="log">開始載入頁面…</pre></div>
  <div class="row"><b>目前頁面來源 / 網域</b><pre id="origin">（尚未取得）</pre></div>
  <div class="row"><b>環境</b><pre id="env">（尚未取得）</pre></div>
  <div class="row"><b>getProfile()</b><pre id="profile">（尚未取得）</pre></div>
  <div class="row"><b>getDecodedIDToken()</b><pre id="idtoken">（尚未取得）</pre></div>
  <div class="row"><b>寫入結果</b><pre id="write">（尚未傳送）</pre></div>
  <div class="row"><b>判斷</b><pre id="judge">（尚未判斷）</pre></div>

<script>
/* ===== 需要你替換的兩個常數 ===== */
var LIFF_ID = "2007686418-Gy0woWJ2";   /* 你的 LIFF ID */
var GAS_URL = "https://script.google.com/macros/s/AKfycbyPZooMVHR-vbayrsmyQWFtYUFoo9R7McYe-8M9pxi7qMiUlzP8tadLe1rUZ35IMive/exec"; /* 這個專案的 exec */

/* ===== 工具 / 錯誤攔截 ===== */
function $(id){ return document.getElementById(id); }
function log(m){ $('log').textContent += "\n" + m; }
window.onerror = function(msg, src, line, col, err){
  var stack = (err && err.stack) ? err.stack : "";
  log("❌ onerror: " + msg + " @ " + src + ":" + line + ":" + col + "\n" + stack);
  $('judge').textContent = "❌ 頁面 JS 錯誤（見步驟日誌）";
};
window.onunhandledrejection = function(ev){
  var e = ev && ev.reason ? ev.reason : ev;
  log("❌ Unhandled Rejection: " + (e && e.message ? e.message : e));
};
log("✅ HTML 已載入 @ " + new Date().toLocaleString());

/* ===== 主流程 ===== */
(function(){
  try {
    $('origin').textContent = JSON.stringify({
      href: location.href, origin: location.origin, host: location.host,
      hostname: location.hostname, protocol: location.protocol
    }, null, 2);

    log("檢查 window.liff：typeof liff = " + (typeof liff));
    if (typeof liff === "undefined") {
      $('judge').textContent = "❌ LIFF SDK 沒載入"; return;
    }

    log("呼叫 liff.init()，liffId=" + LIFF_ID);

    var inited = false;
    var timer = setTimeout(function(){
      if (!inited) {
        log("⏳ liff.init() 逾時");
        $('judge').textContent =
          "⏳ liff.init() 逾時：此頁來源與 LIFF Endpoint 可能不一致；請用 LIFF URL 進入，或改用固定網域。";
      }
    }, 12000);

    liff.init({ liffId: LIFF_ID }).then(function(){
      inited = true; clearTimeout(timer);
      return (liff.ready && typeof liff.ready.then === 'function') ? liff.ready : Promise.resolve();
    }).then(function(){
      var env = {
        inClient: liff.isInClient(), loggedIn: liff.isLoggedIn(),
        os: liff.getOS(), lang: liff.getLanguage(), version: liff.getVersion(),
        lineVersion: (typeof liff.getLineVersion === 'function') ? liff.getLineVersion() : null
      };
      $('env').textContent = JSON.stringify(env, null, 2);
      log("環境就緒：inClient=" + env.inClient + ", loggedIn=" + env.loggedIn);

      if (!liff.isLoggedIn()) {
        log("未登入 → 觸發 liff.login()");
        liff.login({ redirectUri: location.href });
        return Promise.reject("redirect");
      }

      log("呼叫 liff.getProfile()…");
      return liff.getProfile().then(function(prof){
        $('profile').textContent = JSON.stringify(prof, null, 2);
        return prof && prof.userId ? prof.userId : null;
      }).catch(function(e){
        $('profile').textContent = "（失敗）\n" + (e && e.message ? e.message : e);
        return null;
      });
    }).then(function(userId){
      var dec = null;
      try { dec = liff.getDecodedIDToken && liff.getDecodedIDToken(); } catch(e){}
      $('idtoken').textContent = dec ? JSON.stringify(dec, null, 2) : "（沒有 decoded ID token，可能沒勾 openid）";
      if (!userId && dec && dec.sub) userId = dec.sub;

      var msgs = [];
      if (!liff.isInClient()) msgs.push("❌ 不在 LINE App 內（請在 LINE 內建瀏覽器打開）");
      if (userId) msgs.push("✅ 取得 userId：" + userId);
      if (!userId) msgs.push("❌ 取不到 userId → 檢查 scope profile/openid、或按『用 LIFF URL 開啟』");
      $('judge').textContent = msgs.join("\n");

      if (!userId) return null;

      return fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ userId: userId, ts: new Date().toISOString() })
      }).then(function(res){ return res.json(); }).then(function(data){
        if (data && data.ok) { $('write').textContent = "✅ 已成功寫入試算表"; $('write').className="ok"; }
        else { $('write').textContent = "❌ 寫入失敗：" + (data && data.error ? data.error : "未知錯誤"); $('write').className="bad"; }
      }).catch(function(e){
        $('write').textContent = "❌ 寫入失敗（fetch 例外）：" + (e && e.message ? e.message : e); $('write').className="bad";
      });
    }).catch(function(e){
      if (e === "redirect") return;
      log("初始化期間發生錯誤：" + (e && e.message ? e.message : e));
      $('judge').textContent = "❌ liff.init/流程失敗（見步驟日誌）";
    });
  } catch (err) {
    log("初始化 try/catch 例外：" + (err && err.stack ? err.stack : err));
    $('judge').textContent = "❌ 頁面初始化例外";
  }
})();

/* 控制鈕 */
$('btnOpenLiffUrl').onclick = function(){ location.href = "https://liff.line.me/" + LIFF_ID; };
$('btnLogin').onclick     = function(){ liff.login({ redirectUri: location.href }); };
$('btnLogout').onclick    = function(){ liff.logout(); location.reload(); };
$('btnReload').onclick    = function(){ location.reload(); };
</script>
</body>
</html>





